<!DOCTYPE html>
<html lang=pt manifest="manifest.appcache">
<meta charset=utf-8>
<meta name=viewport content="initial-scale=1, minimum-scale=1, width=device-width">
<title>Segunda Semana de Engenharia Civil</title>

<link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.0.2/material.red-indigo.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

<style>
  body {
    background-color: #EEF;
  }
  
  .semana-card-wide {
    transition: opacity 1.2s ease-out;
  }
  
  .semana-card-wide_hidden {
    opacity: 0.2;
  }
  
  .semana-admin-area_hidden,
  .semana-admin-link {
    display: none;
  }
  
  .semana-admin-area_hidden + .semana-admin-link { display: block; }
  
  .semana-admin-area, .semana-card-wide {
    position: absolute;
    top: 7%;
    max-width: 254px;
    margin: 7% auto 1%;
    left: 0;
    right: 0;
  }
  
  .semana-card-wide > .mdl-card__title {
    color: #fff;
    height: 176px;
    /* https://dribbble.com/shots/1965707-Students-desk */
    background: -webkit-linear-gradient(90deg, rgba(0, 0, 0, .5), transparent 50%), url('https://i.imgur.com/kitAlik.png') center / cover;
    background: linear-gradient(0deg, rgba(0, 0, 0, .5), transparent 50%), url('https://i.imgur.com/kitAlik.png') center / cover;
    background-color: #536DFE;
  }
  
  .semana-card-wide > .mdl-card__menu {
    color: #fff;
  }
  
  .semana-admin-link {
    opacity: 0.2;
    transition: opacity 0.3s;
    position: absolute;
    bottom: 7%;
    left: 50%;
    transform: translateX(-50%);
  }
  
  .semana-admin-link:hover, .semana-admin-link:focus { opacity: 1; }
  
  .semana-admin-area {
    text-align: center;
    padding: 2em;
  }
  .semana-admin-area > * { margin: 0.5em auto; }
</style>

<body>
  <div class="mdl-card mdl-shadow--2dp semana-card-wide">
    <div class="mdl-card__title">
      <h2 id="semanaTitle" class="mdl-card__title-text">Carregando</h2>
    </div>
    <div id="semanaMessage" class="mdl-card__supporting-text">A página está sendo carregada</div>
  </div>
  <!-- In case of no javascript redirect it to a unexistent host -->
  <form class="semana-admin-area mdl-card mdl-shadow--2dp semana-admin-area_hidden" action="https://127.0.0.1/">
    <label>Faça login para continuar</label>
    <input class="mdl-textfield__input" type="text" id="user" placeholder="Login">
    <input class="mdl-textfield__input" type="password" id="pass" placeholder="Senha">
    <input class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" id="doLogin" type="submit" value="Fazer login">
  </form>
  <button class="mdl-button mdl-js-button semana-admin-link">Alterar credenciais</button>
  
  <!-- Typed Array fallback, based on the famous H5BP jQuery fallback -->
  <script>window.Uint8Array || document.write('<script src="https://cdn.rawgit.com/inexorabletash/polyfill/1787e143a8ee7b0747ac8c974d98dcec5669b89e/typedarray.js"><\/script>');</script>
  <script src="https://cdn.rawgit.com/dchest/tweetnacl-js/9e1ef31362dfe88aa9ca96468cdc3f28d72ba2da/nacl-fast.min.js"></script>
  <script>
    var container = document.getElementsByClassName('semana-card-wide')[0];
    var adminLink = document.getElementsByClassName('semana-admin-link')[0];
    var doLoginForm = document.getElementsByClassName('semana-admin-area')[0];
    var doLoginBtn = document.getElementById('doLogin');

    var websiteSalt = nacl.util.decodeUTF8('segunda-semana');

    function typedConcat() {
      var i;
      var result;
      var totalLength = 0;

      for (i = 0; i < arguments.length; i++) {
        totalLength += arguments[i].length;
      }

      result = new Uint8Array(totalLength);
      totalLength = 0; // reuse

      for (i = 0; i < arguments.length; i++) {
        result.set(arguments[i], totalLength);
        totalLength += arguments[i].length;
      }

      return result;
    }

    function generateKeyPair(userEl, passEl) {
      var hash = new Uint8Array([]);
      var user = nacl.util.decodeUTF8(userEl.value.trim().toLowerCase());
      var pass = nacl.util.decodeUTF8(passEl.value);

      var userData = typedConcat(
        user,
        websiteSalt,
        pass
      );

      // Target devices are mobile ones
      // By the way, no one will try to break this.
      for (var i = 0; i < 500; i++) {
        hash = nacl.hash(typedConcat(
          userData,
          hash,
          userData
        ));
      }

      return hash.slice(0, 32);
    }

    adminLink.addEventListener('click', accessAdminArea);

    function accessAdminArea(evt) {
      if (evt && evt.preventDefault) {evt.preventDefault();}
      document.getElementsByClassName('semana-admin-area')[0].classList
        .toggle('semana-admin-area_hidden');
      container.classList.toggle('semana-card-wide_hidden');
    }

    var credentials;
    var user = '';
    if (localStorage.credentials) {
      doLoginBtn.textContent = 'Atualizar credenciais';
      doLogin(nacl.util.decodeBase64(localStorage.credentials));
    }

    function doLogin(password) {
      credentials = nacl.sign.keyPair.fromSeed(password);
      user = nacl.util.encodeBase64(credentials.publicKey);
    }

    doLoginForm.addEventListener('submit', function (evt) {
      evt.preventDefault();
      accessAdminArea();
      var seed = generateKeyPair(
        document.getElementById('user'),
        document.getElementById('pass'));

      localStorage.credentials = nacl.util.encodeBase64(seed);
      doLogin(seed);
      loop();
    });

    if (navigator.serviceWorker) {
      navigator.serviceWorker.register('sw.js', {
        scope: '.'
      });
    }

    var data = [(location.href.match(/aluno=(\d+)/) || [])[1]];
    if (localStorage.offlineData) {
      try {
        data = data.concat(JSON.parse(localStorage.offlineData));
      } catch (e) {}
      localStorage.offlineData = '';
    }
    
    data = data.filter(function(e){return e;});

    if (user) {
      loop();
    } else {
      accessAdminArea();
    }

    function loop() {
      var el = data.shift(); if (!el) {return;}
      var callbackName = '_callback' + Date.now();
      
      showResult({titulo: 'Carregando', mensagem: 'Aguarde enquanto o servidor é contactado'})
      
      var script = document.createElement('script');
      var hora = Date.now();
      var sign = nacl.util.encodeBase64(nacl.sign.detached(
        nacl.util.decodeUTF8(JSON.stringify({
          aluno: el,
          hora: hora // Let's avoid replay attacks
        })),
        credentials.secretKey
      ));

      script.src = 'https://script.google.com/macros/s/AKfycbw-kz-BrkJN91Iw01TBh0FEppQlHAk4amAQzz3bwGkuIE6UlM8/exec' +
        '?callback=' + encodeURIComponent(callbackName) +
        '&aluno=' + el +
        '&user=' + user +
        '&pass=' + sign +
        '&hora=' + hora;

      container.classList.add('semana-card-wide_hidden');

      var timer = setTimeout(function () {
        data.push(el);
        timer = false;
        handleResult({
          titulo: 'Erro',
          mensagem: 'Erro na conexão'
        });
      }, 30e3);

      window[callbackName] = function (result) {
        if (timer !== false) {
          clearTimeout(timer);
          handleResult(result);
        }
      };

      document.head.appendChild(script);
      script.addEventListener('load', function () {
        document.head.removeChild(script);
      });
      
      function handleResult (result) {
        container.classList.remove('semana-card-wide_hidden');
        showResult(result);

        if (data.length) {
          setTimeout(loop, 2500);
        } else {
          timer = null;
        }
      }
    }
      
    function showResult(result) {
      document.getElementById('semanaTitle').textContent = result.titulo;
      document.getElementById('semanaMessage').textContent = result.mensagem;
    }
  </script>
</body>

</html>