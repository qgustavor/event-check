<!DOCTYPE html>
<html lang=pt>
<meta charset=utf-8>
<meta name=viewport content="initial-scale=1, minimum-scale=1, width=device-width">
<title>Segunda Semana de Engenharia Civil</title>

<link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.0.2/material.red-indigo.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

<style>
  body {
    background-color: #EEF;
  }
  
  .semana-card-wide {
    transition: opacity 1.2s ease-out;
  }
  
  .semana-card-wide_hidden {
    opacity: 0.2;
  }
  
  .semana-admin-area_hidden,
  .semana-admin-link {
    display: none;
  }
  
  .semana-admin-area_hidden + .semana-admin-link { display: block; }
  
  .semana-admin-area, .semana-card-wide {
    position: absolute;
    top: 7%;
    max-width: 254px;
    margin: 7% auto 1%;
    left: 0;
    right: 0;
  }
  
  .semana-card-wide > .mdl-card__title {
    color: #FFF;
    height: 176px;
    /* https://dribbble.com/shots/1965707-Students-desk */
    background: -webkit-linear-gradient(0deg, #448D74, rgba(193, 225, 214, 0)), url('https://i.imgur.com/kitAlik.png') center / cover;
    background: linear-gradient(0deg, #448D74, rgba(193, 225, 214, 0)), url('https://i.imgur.com/kitAlik.png') center / cover;
    background-color: #448D74;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
  }
  
  .semana-card-wide > .mdl-card__menu {
    color: #fff;
  }
  
  .semana-card-wide_signup > .mdl-card__supporting-text {
    word-break: break-all;
  }
  
  .semana-admin-link {
    opacity: 0.2;
    transition: opacity 0.3s;
    position: absolute;
    bottom: 7%;
    left: 50%;
    transform: translateX(-50%);
  }
  
  .semana-admin-link:hover, .semana-admin-link:focus { opacity: 1; }
  
  .semana-admin-area {
    text-align: center;
    padding: 2em;
  }
  .semana-admin-area > * { margin: 0.5em auto; }
</style>

<body>
  <div class="mdl-card mdl-shadow--2dp semana-card-wide">
    <div class="mdl-card__title">
      <h2 id="semanaTitle" class="mdl-card__title-text">Carregando</h2>
    </div>
    <div id="semanaMessage" class="mdl-card__supporting-text">A página está sendo carregada</div>
  </div>
  <!-- In case of no javascript redirect it to a unexistent host -->
  <form class="semana-admin-area mdl-card mdl-shadow--2dp semana-admin-area_hidden" action="https://[::1]/" method="POST">
    <label>Faça login para continuar</label>
    <input class="mdl-textfield__input" type="text" id="user" placeholder="Login">
    <input class="mdl-textfield__input" type="password" id="pass" placeholder="Senha">
    <input class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" id="doLogin" type="submit" value="Fazer login">
  </form>
  <button class="mdl-button mdl-js-button semana-admin-link">Alterar credenciais</button>
  
  <!-- Typed Array fallback, based on the famous H5BP jQuery fallback -->
  <script>window.Uint8Array || document.write('<script src="https://cdn.rawgit.com/inexorabletash/polyfill/1787e143a8ee7b0747ac8c974d98dcec5669b89e/typedarray.js"><\/script>');</script>
  <script src="https://cdn.rawgit.com/dchest/tweetnacl-js/9e1ef31362dfe88aa9ca96468cdc3f28d72ba2da/nacl-fast.min.js"></script>
  <script>		/* global nacl */ /* yes, it passes jshint (without strict mode) */
    var container = document.getElementsByClassName('semana-card-wide')[0];
    var adminLink = document.getElementsByClassName('semana-admin-link')[0];
    var doLoginForm = document.getElementsByClassName('semana-admin-area')[0];
    var doLoginBtn = document.getElementById('doLogin');

    var websiteSalt = nacl.util.decodeUTF8('segunda-semana');

    function typedConcat() {
      var i;
      var result;
      var totalLength = 0;

      for (i = 0; i < arguments.length; i++) {
        totalLength += arguments[i].length;
      }

      result = new Uint8Array(totalLength);
      totalLength = 0; // reuse

      for (i = 0; i < arguments.length; i++) {
        result.set(arguments[i], totalLength);
        totalLength += arguments[i].length;
      }

      return result;
    }

    function generateKeyPair(user, pass) {
      var hash = new Uint8Array([]);
      // People expect that the user is normalized
      user = nacl.util.decodeUTF8(user.toLowerCase());
      pass = nacl.util.decodeUTF8(pass);

      var userData = typedConcat(
        user,
        websiteSalt,
        pass
      );

      // Target devices are phones, so the small loop count.
      // By the way, no one will ever try to break this.
      for (var i = 0; i < 500; i++) {
        hash = nacl.hash(typedConcat(
          userData,
          hash,
          userData
        ));
      }

      return hash.slice(0, 32);
    }

    adminLink.addEventListener('click', accessAdminArea);

    function accessAdminArea(evt) {
      if (evt && evt.preventDefault) {evt.preventDefault();}
      document.getElementsByClassName('semana-admin-area')[0].classList
        .toggle('semana-admin-area_hidden');
      container.classList.toggle('semana-card-wide_hidden');
    }

    var credentials;
    var user = '';
    if (localStorage.credentials) {
      doLoginBtn.textContent = 'Atualizar credenciais';
      var parts = localStorage.credentials.split('!');
      doLogin(parts[0], nacl.util.decodeBase64(parts[1]));
    }

    function doLogin(userInput, password) {
      user = userInput;
      credentials = nacl.sign.keyPair.fromSeed(password);
    }

    doLoginForm.addEventListener('submit', function (evt) {
      evt.preventDefault();
      accessAdminArea();
      var user = document.getElementById('user').value.trim();
      var passEl = document.getElementById('pass');
      var seed = generateKeyPair(user, passEl.value);
      passEl.value = '';

      localStorage.credentials = user + '!' + nacl.util.encodeBase64(seed);
      doLogin(user, seed);
      afterLogged();
    });

    if (navigator.serviceWorker) {
      navigator.serviceWorker.register('sw.js', {
        scope: '.'
      });
    } else {
      var iframe = document.createElement('iframe');
      iframe.style.position = 'absolute';
      iframe.style.top = '-100%';
      iframe.style.height = '1px';
      iframe.src = 'offline.html';
      iframe.addEventListener('load', function () {
        document.body.removeChild(iframe);  
      });
      document.body.appendChild(iframe);
    }

    var data = [];
    var currentId = location.href.match(/aluno=(\d+)/);
    
    if (currentId) {
      data.push({
        id: currentId[1],
        hora: new Date().toISOString()
      });
    }
    
    if (localStorage.offlineData) {
      try {
        data = data.concat(JSON.parse(localStorage.offlineData));
      } catch (e) {}
      localStorage.offlineData = '';
    }
    
    data = data.filter(function(e){return e;});

    if (user) {
      afterLogged();
    } else {
      accessAdminArea();
    }
    
    function afterLogged() {
      if (location.hash === '#signup') {
        showResult({
          titulo: 'Registro de responsável',
          mensagem: 'Adicione o seguinte linha a planilha de responsaveis: "' + user +
            '", "' + nacl.util.encodeBase64(credentials.publicKey) + '" (sem as aspas)'
        });
        container.classList.add('semana-card-wide_signup');
      } else {
        loop();
      }
    }

    function loop() {
      var el = data.shift(); if (!el) {return;}
      
      // Backards compatibility
      if (!el.id) {
        el = {
          id: el,
          hora: Date.now()
        };
      }
      
      var callbackName = '_callback' + Date.now();
      
      showResult({titulo: 'Carregando', mensagem: 'Aguarde enquanto o servidor é contactado'});
      
      var script = document.createElement('script');
      // Dear cryptographers, I know it's insecure against active attacks
      // But those are a lot hard, as we're using HTTPS
      // And it's a lot better than other authentication methods
      var sign = nacl.util.encodeBase64(nacl.sign.detached(
        nacl.util.decodeUTF8(JSON.stringify({
          aluno: el.id,
          hora: el.hora
        })),
        credentials.secretKey
      ));

      script.src = 'https://script.google.com/macros/s/AKfycbw-kz-BrkJN91Iw01TBh0FEppQlHAk4amAQzz3bwGkuIE6UlM8/exec' +
        '?callback=' + encodeURIComponent(callbackName) +
        '&aluno=' + encodeURIComponent(el.id) +
        '&user=' + encodeURIComponent(user) +
        '&pass=' + encodeURIComponent(sign) +
        '&hora=' + encodeURIComponent(el.hora);

      container.classList.add('semana-card-wide_hidden');

      var timer = setTimeout(function () {
        data.push(el);
        timer = false;
        handleResult({
          titulo: 'Erro',
          mensagem: 'Erro na conexão'
        });
      }, 30e3);

      window[callbackName] = function (result) {
        if (timer !== false) {
          clearTimeout(timer);
          handleResult(result);
        }
      };

      document.head.appendChild(script);
      script.addEventListener('load', function () {
        document.head.removeChild(script);
      });
      
      function handleResult (result) {
        container.classList.remove('semana-card-wide_hidden');
        showResult(result);

        if (data.length) {
          setTimeout(loop, 2500);
        } else {
          timer = null;
        }
      }
    }
      
    function showResult(result) {
      document.getElementById('semanaTitle').textContent = result.titulo;
      document.getElementById('semanaMessage').textContent = result.mensagem;
    }
  </script>
</body>

</html>